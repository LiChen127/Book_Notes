# 第四章 网络层

## 4.1 网络层提供的两种服务

在计算机网络领域，网络层应该向运输层提供怎样的服务（​“面向连接”还是“无连接”​）曾引起了长期的争论。争论焦点的实质就是：在计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？

### 电信网设计思路

传统电信网的主要业务是提供电话服务。电信网使用昂贵的程控交换机（其软件也非常复杂）​，用面向连接的通信方式，使电信网络能够向用户（实际上就是电话机）提供可靠传输的服务。

因此他们认为，计算机网络也应模仿打电话所使用的面向连接的通信方式。当两个计算机进行通信时，也应当先建立连接（但在分组交换中是建立一条**虚电路 VC (Virtual Circuit)）**​，以保证双方通信所需的一切网络资源。然后双方就沿着已建立的虚电路发送分组。这样的分组的首部不需要填写完整的目的主机地址，而只需要填写这条虚电路的编号（一个不大的整数）​，因而减少了分组的开销。

这种通信方式如果再使用这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，当然也不丢失、不重复。在通信结束后要释放建立的虚电路.

### 因特网的先驱的设计思路

电信网提供的端到端可靠传输的服务对电话业务无疑是很合适的，但是电信网的终端（电话机）非常简单，没有智能，也没有差错处理能力。因此电信网必须负责把用户电话机产生的话音信号可靠地传送到对方的电话机，使还原后的话音质量符合技术规范的要求。但计算机网络的**端系统是有智能的计算机**。**计算机有很强的差错处理的能力**（这点和传统的电话机有本质上的差别）​。

设计思路: **网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务**。
网络在发送分组时不需要先建立连接。每一个分组（也就是IP数据报）独立发送，与其前后的分组无关（不进行编号）​。
**网络层不提供服务质量的承诺**。也就是说，所传送的分组可能出错、丢失、重复和失序（即不按序到达终点）​，当然也不保证分组交付的时限。
这样意味着网络中的路由器可以做得比较简单

采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用。因特网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。

## 4.2 网际协议IP

**网际协议IP**是TCP/IP体系中两个最主要的协议之一[STEV94]​[COME06]​[FORO10]​，也是最重要的因特网标准协议之一。

与IP协议配套的还有三个协议:

- 地址解析协议ARP(Address Resolution Protocol)
- 网际控制报文协议ICMP(Internet Control Message Protocol)
- 网际组管理协议IGMP(Internet Group Management Protocol)

由于网际协议IP是用来使互连起来的许多计算机网络能够进行通信，因此TCP/IP体系中的网络层常常称为网际层(internet layer)，或IP层。

![alt text](image.png)

讨论IP协议之前，要先知道什么是虚拟互连网络

### 4.2.1 虚拟互连网络

如果要在全世界范围内把数以百万计的网络都互连起来，并且能够互相通信，那么这样的任务一定非常复杂。其中会遇到许多问题需要解决
比如:
![alt text](image-1.png)

能不能让大家都使用相同的网络，这样可使网络互连变得比较简单。答案是不行的。因为用户的需求是多种多样的，**没有一种单一的网络能够适应所有用户的需求**。

从一般的概念来讲，将网络互相连接起来要使用一些**中间设备**。根据中间设备所在的层次，可以有以下四种不同的中间设备:

1. 物理层使用的中间设备: **转发器(repeater)**
2. 数据链路层使用的中间设备: **网桥/桥接器**
3. 网络层使用的中间设备: **路由器(router)**
4. 网络层以上使用的中间设备: **网关(gateway)**, 用网关连接两个不兼容的系统需要在高层进行协议的转换。

**由于历史的原因，许多有关TCP/IP的文献曾经把网络层使用的路由器称为网关**

现在我们讨论网络互连时，都是指用路由器进行网络互连和路由选择。路由器其实就是一台专用计算机，用来在互联网中进行路由选择

TCP/IP协议在网络互连上采用的做法是在网络层(IP层)采用标准化协议，但相互连接的网络则可以是异构的。

由于参加互连的计算机网络都使用相同的网际协议IP (Internet Protocol), 因此可以把互连以后的计算机网络看成一个虚拟互连网络(internet)。

所谓的虚拟互联网络实际上就是逻辑互联网络, 它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用IP协议就可以使这些性能各异的网络在网络层上看起来好像是一个统一的网络。

这种使用IP协议的虚拟互连网络可简称为IP网（IP网是虚拟的，但平常不必每次都强调“虚拟”二字）​。

使用IP网的好处是：当IP网上的主机进行通信时，就好像在一个单个网络上通信一样，它们看不见互连的各网络的具体异构细节（如具体的编址方案、路由选择协议，等等）​。

### 4.2.2 分类的IP地址

在TCP/IP体系中，IP地址是一个最基本的概念，一定要把它弄清楚。有关IP最重要的文档就是RFC 791

#### IP地址及其表示方法

整个的因特网就是一个单一的、抽象的网络。IP地址就是给因特网上的每一个主机（或路由器）的每一个接口分配一个在全世界范围是唯一的32位的标识符。

P地址的结构使我们可以在因特网上很方便地进行寻址。IP地址现在由**因特网名字和数字分配机构ICANN (Internet Corporation for Assigned Names and Numbers)**进行分配

IP地址的编址一共经过了三个历史阶段:

1. 分类的IP地址
2. 子网的划分
3. 构成超网

所谓“分类的IP地址”就是将IP地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成，其中第一个字段是网络号(net-id)，它标志主机（或路由器）所连接到的网络。
一个网络号在整个因特网范围内必须是唯一的。第二个字段是主机号(host-id)，它标志该主机（或路由器）​。一个主机号在它前面的网络号所指明的网络范围内必须是唯一的。由此可见，一个IP地址在整个因特网范围内是唯一的。
![alt text](image-2.png)

从IP地址的结构来看，IP地址并不仅仅指明一个主机，而是还指明了主机所连接到的网络。

对主机或路由器来说，IP地址都是32位的二进制代码。为了提高可读性，我们常常把32位的IP地址中的每8位插入一个空格（但在机器中并没有这样的空格）​。要更加便于使用，可用其等效的十进制数字表示，并且在这些数字之间加上一个点。这就叫做点分十进制记法(dotted decimal notation)。

#### 常用的三种类别的IP地址

ABC类

#### IP地址的特点

1. 每个IP地址都由网络号和主机号两部分组成。从这个意义上说，IP地址是一种分等级的地址结构。分两个等级的好处是：第一，IP地址管理机构在分配IP地址时只分配网络号（第一级）​，而剩下的主机号（第二级）则由得到该网络号的单位自行分配。这样就方便了IP地址的管理。第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号）​，这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间以及查找路由表的时间。
2. 实际上IP地址是标志一个主机（或路由器）和一条链路的接口。当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的IP地址，其网络号必须是不同的。这种主机称为多归属主机(multihomed host)。由于一个路由器至少应当连接到两个网络，因此一个路由器至少应当有两个不同的IP地址。
3. 按照因特网的观点，一个网络是指具有相同网络号net-id的主机的集合，因此，**用转发器或网桥连接起来的若干个局域网仍为一个网络**，因为这些局域网都具有同样的网络号。具有不同网络号的局域网必须使用路由器进行互连。
4. 在IP地址中，所有分配到网络号的网络(不管是范围很小的局域网，还是可能覆盖很大地理范围的广域网)都是平等的。所谓平等，是指因特网同等对待每一个IP地址。

#### 注意

- 在同一个局域网上的主机或路由器的IP地址中的网络号必须是一样的
- 用网桥（它只在链路层工作）互连的网段仍然是一个局域网，只能有一个网络号。
- 路由器总是具有两个或两个以上的IP地址。即路由器的每一个接口都有一个不同网络号的IP地址。
- 当两个路由器直接相连时（例如通过一条租用线路）​，在连线两端的接口处，可以分配也可以不分配IP地址。

### 4.2.3 IP地址与硬件地址

如何区分主机的IP地址和硬件地址

层次的角度看: **物理地址是数据链路层和物理层使用的地址**，**IP地址是网络层以及以上各层使用的地址，是一种逻辑地址(因为IP地址是软件实现的)**
在发送数据时，数据从高层下到低层，然后才到通信链路上传输。使用IP地址的IP数据报一旦交给了数据链路层，就被封装成**MAC帧**了。**MAC帧在传送时使用的源地址和目的地址都是硬件地址**，这两个硬件地址都写在**MAC帧的首部**中。

![alt text](image-3.png)

连接在通信链路上的设备（主机或路由器）在接收MAC帧时，**其根据是MAC帧首部中的硬件地址**。在数据链路层看不见隐藏在MAC帧的数据中的IP地址。只有在剥去MAC帧的首部和尾部后把MAC层的数据上交给网络层后，**网络层才能在IP数据报的首部中找到源IP地址和目的IP地址**。

总之, **IP地址放在IP数据报的首部，硬件地址则放在MAC帧的首部。在网络层和网络层以上使用的是IP地址，数据链路层物理层使用硬件地址, 当IP数据报放入数据链路层的MAC帧中以后，整个的IP数据报就成为MAC帧的数据，因而在数据链路层看不见数据报的IP地址。**

注意:

1. 在IP层抽象的互联网上只能看到IP数据报。虽然IP数据报要经过路由器R1和R2的两次转发，但在它的首部中的源地址和目的地址始终分别是IP1和IP2。图中的数据报上写的“从IP1到IP2”就表示前者是源地址而后者是目的地址。数据报中间经过的两个路由器的IP地址并不出现在IP数据报的首部中。
2. 虽然在IP数据报首部有源站IP地址，但**路由器只根据目的站的IP地址的网络号进行路由选择**。
3. 在局域网的链路层，只能看见MAC帧
4. 尽管互连在一起的网络的硬件地址体系各不相同，但**IP层抽象的互联网却屏蔽了下层这些很复杂的细节。只要我们在网络层上讨论问题，就能够使用统一的、抽象的IP地址研究主机和主机或路由器之间的通信。**

两个问题:

1. 主机或路由器怎样知道应当在MAC帧的首部填入什么样的硬件地址？
2. 路由器中的路由表是怎样得出的

### 4.2.4 地址解析协议ARP

在实际应用中，我们经常会遇到这样的问题：已经知道了一个机器（主机或路由器）的IP地址，需要找出其相应的硬件地址。**地址解析协议ARP就是用来解决这样的问题的。**

由于传送ARP分组使用是IP协议，因此应当把ARP协议划归网络层。但**ARP协议的用途是为了从网络层使用的IP地址解析出在数据链路层使用的硬件地址。**

网络层使用的是IP地址，但在实际网络的链路上传送数据帧时，最终还是必须使用该网络的硬件地址。但IP地址和下面的网络的硬件地址之间由于格式不同而不存在简单的映射关系

**ARP解决这个问题的方法是在主机ARP高速缓存中应存放一个从IP地址到硬件地址的映射表，并且这个映射表还经常动态更新(新增或超时删除)**

每一个主机都设有一个ARP高速缓存(ARP cache)，里面有本局域网上的各主机和路由器的IP地址到硬件地址的映射表，这些都是该主机目前知道的一些地址。那么主机怎样知道这些地址呢？

当主机A要向本局域网上的某个主机B发送IP数据报时，就先在其ARP高速缓存中查看有无主机B的IP地址。如有，就在ARP高速缓存中查出其对应的硬件地址，再把这个硬件地址写入MAC帧，然后通过局域网把该MAC帧发往此硬件地址。

也有可能查不到主机B的IP地址的项目。这可能是主机B才入网，也可能是主机A刚刚加电，其高速缓存还是空的。在这种情况下，主机A就自动运行ARP, 然后按以下步骤找出主机B的硬件地址。

1. ARP进程在本局域网上广播发送一个ARP请求分组
2. 在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组。
3. 主机B的IP地址与ARP请求分组中要查询的IP地址一致，就收下这个ARP请求分组，并向主机A发送ARP响应分组（其格式见[COME06]​）​，并在这个ARP响应分组中写入自己的硬件地址。
4. 主机A收到主机B的ARP响应分组后，就在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射。

当主机A向B发送数据报时，很可能以后不久主机B还要向A发送数据报，因而主机B也可能要向A发送ARP请求分组。为了减少网络上的通信量，主机A在发送其ARP请求分组时，就把自己的IP地址到硬件地址的映射写入ARP请求分组。当主机B收到A的ARP请求分组时，就把主机A的这一地址映射写入主机B自己的ARP高速缓存中。以后主机B向A发送数据报时就很方便了。

可见ARP高速缓存非常有用。如果不使用ARP高速缓存，那么任何一个主机只要进行一次通信，就必须在网络上用广播方式发送ARP请求分组，这就使网络上的通信量大大增加。ARP把已经得到的地址映射保存在高速缓存中，这样就使得该主机下次再和具有同样目的地址的主机通信时，可以直接从高速缓存中找到所需的硬件地址而不必再用广播方式发送ARP请求分组。

ARP把保存在高速缓存中的每一个映射地址项目都设置生存时间

请注意，ARP是解决**同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题**

从IP地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。只要主机或路由器要和本网络上的另一个已知IP地址的主机或路由器进行通信，ARP协议就会自动地把这个IP地址解析为链路层所需要的硬件地址。

#### 既然在网络链路上传送的帧最终是按照硬件地址找到目的主机的，那么为什么我们不直接使用硬件地址进行通信，而是要使用抽象的IP地址并调用ARP来寻找出相应的硬件地址呢？

由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此由用户或用户主机来完成这项工作几乎是不可能的事。但统一的IP地址把这个复杂问题解决了。连接到因特网的主机只需拥有统一的IP地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为上述的调用ARP的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。

### 4.2.5 IP数据报的格式

IP数据报的格式能够说明IP协议都具有什么功能。在TCP/IP的标准中，各种数据格式常常以32位(即4字节)为单位来描述。

一个IP数据报由首部和数据两部分组成。首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。

首部各个字段的意义:

1. IP数据报首部的固定部分中的各字段
   1. 版本: 占4位，指IP协议的版本。通信双方使用的IP协议的版本必须一致。IPV4,IPV6
   2. 首部长度:  占4位，可表示的最大十进制数值是15
   3. 区分服务: 占8位，用来获得更好的服务。这个字段在旧标准中叫做服务类型，但实际上一直没有被使用过。1998年IETF把这个字段改名为区分服务 DS (Differentiated Services)。
   4. 总长度: 总长度指首部和数据之和的长度，单位为字节。总长度字段为16位，因此数据报的最大长度为216 - 1 = 65 535字节。 然而实际上传送这样长的数据报在现实中是极少遇到的。

我们知道，**在IP层下面的每一种数据链路层协议都规定了一个数据帧中的数据字段的最大长度，这称为最大传送单元MTU (Maximum Transfer Unit)**。当一个IP数据报封装成链路层的帧时，此数据报的总长度（即首部加上数据部分）一定不能超过下面的数据链路层所规定的MTU值。例如，最常用的以太网就规定其MTU值是1 500字节。**若所传送的数据报长度超过数据链路层的MTU值，就必须把过长的数据报进行分片处理。**

虽然使用尽可能长的IP数据报会使传输效率提高（因为每一个IP数据报中首部长度占数据报总长度的比例就会小些）​，但数据报短些也有好处。每一个IP数据报越短，路由器转发的速度就越快。为此，IP协议规定，在因特网中所有的主机和路由器，必须能够接受长度不超过576字节的数据报。这是假定上层交下来的数据长度有512字节（合理的长度）​，加上最长的IP首部60字节，再加上4字节的富裕量，就得到576字节。当主机需要发送长度超过576字节的数据报时，应当先了解一下，目的主机能否接受所要发送的数据报长度。否则，就要进行分片。

在进行分片时, 数据报首部中的“总长度”字段是指分片后的每一个分片的首部长度与该分片的的数据长度的总和。
  5. 标识(identification): 占16位。IP软件在存储器中维持一个计数器，每产生一个数据报，计数器就加1，并将此值赋给标识字段。但这个“标识”并不是序号，因为IP是无连接服务，数据报不存在按序接收的问题。当数据报由于长度超过网络的MTU而必须分片时，这个标识字段的值就被复制到所有的数据报片的标识字段中。相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报。
  6. 标志(flag):  占3位，但目前只有两位有意义。
    - 标志字段中的最低位记为MF (More Fragment)。MF = 1即表示后面“还有分片”的数据报。MF = 0表示这已是若干数据报片中的最后一个。
    - 标志字段中间的一位记为DF (Don't Fragment)，意思是“不能分片”​。只有当DF = 0时才允许分片。
  7. 片偏移: 占13位。片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。也就是说，相对于用户数据字段的起点，该片从何处开始。片偏移以8个字节为偏移单位。这就是说，每个分片的长度一定是8字节（64位）的整数倍。
  8. 生存空间:占8位，生存时间字段常用的英文缩写是TTL (Time To Live)，表明是数据报在网络中的寿命。由发出数据报的源点设置这个字段。其目的是防止无法交付的数据报无限制地在因特网中兜圈子（例如从路由器R1转发到R2，再转发到R3，然后又转发到R1）​，因而白白消耗网络资源。
  9. 协议: 占8位，协议字段指出此数据报携带的数据是使用何种协议，以便使目的主机的IP层知道应将数据部分上交给哪个处理过程。
  10. 首部检验和: 占16位。这个字段只检验数据报的首部，但不包括数据部分。
  11. 源地址: 占32位。
  12. 目的地址: 占32位。
2. IP数据报首部的可变部分: IP首部的可变部分就是一个选项字段。选项字段用来支持排错、测量以及安全等措施，内容很丰富。此字段的长度可变，从1个字节到40个字节不等，取决于所选择的项目。
   增加首部的可变部分是为了增加IP数据报的功能，但这同时也使得IP数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。实际上这些选项很少被使用。很多路由器都不考虑IP首部的选项字段，因此新的IP版本**IPv6就把IP数据报的首部长度做成固定的**。

### 4.2.6 IP层转发分组的流程

在互联网上转发分组时，是从一个路由器转发到下一个路由器。

总之，在路由表中，对每一条路由最主要的是以下两个信息:

1. 目的网络地址
2. 下一跳地址

我们就根据目的网络地址来确定下一跳路由器，这样做得出以下的结果:

1. IP数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）​。
2. 只有到达最后一个路由器时，才试图向目的主机进行直接交付。


虽然因特网所有的分组转发都是**基于目的主机所在的网络**，但在大多数情况下都允许有这样的特例，**即对特定的目的主机指明一个路由。这种路由叫做特定主机路由。**采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。在对网络的连接或路由表进行排错时，指明到某一个主机的特殊路由就十分有用。

路由器还可采用默认路由(default route)以减少路由表所占用的空间和搜索路由表所用的时间。这种转发方式在一个网络只有很少的对外连接时是很有用的。实际上，默认路由在主机发送IP数据报时往往更能显示出它的好处。

在IP数据报的首部中没有地方可以用来指明“下一跳路由器的IP地址”​。在IP数据报的首部写上的IP地址是源IP地址和目的IP地址，而没有中间经过的路由器的IP地址。既然IP数据报中没有下一跳路由器的IP地址，那么**待转发的数据报又怎样能够找到下一跳路由器呢？**

当路由器收到一个待转发的数据报，在从路由表得出下一跳路由器的IP地址后，不是把这个地址填入IP数据报，而是**送交数据链路层的网络接口软件**。
网络接口软件负责把下一跳路由器的IP地址转换成硬件地址(ARP), 并将此硬件地址放在链路层的MAC帧的首部，然后根据这个硬件地址找到下一跳路由器。

由此可见，当发送一连串的数据报时，上述的这种查找路由表、计算硬件地址、写入MAC帧的首部等过程，将不断地重复进行，造成了一定的开销。

那么，能不能在路由表中不使用IP地址而直接使用硬件地址呢？不行。我们一定要弄清楚，使用抽象的IP地址，本来就是为了隐蔽各种底层网络的复杂性而便于分析和研究问题，这样就不可避免地要付出些代价

分组转发算法:

1. 从数据包的首部提取目的主机的IP地址D，得出目的网络地址为N
2. 若N就是与此路由器直接相连的某个网络地址，则进行直接交付，不需要再经过其他的路由器，直接把数据报交付目的主机（这里包括把目的主机地址 D转换为具体的硬件地址，把数据报封装为MAC帧，再发送此帧）​；否则就是间接交付，执行3
3. 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)。
4. 若路由表中有到达网络N的路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(5)。
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)。
6. 报告转发分组出错。

