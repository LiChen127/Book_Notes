# 第八章_因特网上的音频_视频服务

## 8.1 概述

计算机网络最初是为传送数据设计的。因特网IP层提供的“尽最大努力交付”服务以及每一个分组独立交付的策略，对传送数据信息十分合适。因特网使用的TCP协议可以很好地解决IP层不能提供可靠交付这一问题。

多媒体信息（包括声音和图像信息）与不包括声音和图像的数据信息有很大的区别，其中最主要的两个特点如下。

1. 多媒体信息的信息量很大
2. 传输多媒体数据时，对时延和时延抖动均有较高的要求

模拟的多媒体信号只有经过数字化后才能在因特网上传送。就是对模拟信号要经过采样和模数转换变为数字信号，然后将一定数量的比特组装成分组进行传送。这些分组在发送时的时间间隔都是恒定的，通常称这样的分组为等时的(isochronous)。这种等时分组进入因特网的速率也是恒定的。但传统的因特网本身是非等时的。这是因为在使用IP协议的因特网中，每一个分组是独立地传送，因而这些分组在到达接收端时就变成为非等时的。如果我们在接收端对这些以非恒定速率到达的分组边接收边还原，那么就一定会产生很大的失真

要解决这一问题，可以在接收端设置适当大小的缓存[插图]，当缓存中的分组数达到一定的数量后再以恒定速率按顺序将这些分组读出进行还原播放。

通过缓存, 非等时的分组->等时的

缓存实际上就是一个先进先出的队列。图中标明的T叫做播放时延，这就是从最初的分组开始到达缓存算起，经过时间 T 后就按固定时间间隔把缓存中的分组按先后顺序依次读出。我们看到，缓存使所有到达的分组都经受了迟延。由于分组以非恒定速率到达，因此早到达的分组在缓存中停留的时间较长，而晚到达的分组在缓存中停留的时间就较短。从缓存中取出分组是按照固定的时钟节拍进行的，因此，到达的非等时的分组，经过缓存后再以恒定速率读出，就变成了等时的分组

这就在很大程度上消除了时延的抖动。但我们付出的代价是增加了时延

因此实时数据的传输在运输层就应采用用户数据报协议UDP而不使用TCP协议。这就是说，对于传送实时数据，我们宁可丢失少量分组（当然不能丢失太多）​，也不要太晚到达的分组。

丢失容忍(loss tolerant)也是实时数据的另一个重要特点。

目前因特网提供的音频/视频服务大体上可分为三种类型：

1. streaming存储视频/音频: 这种类型是先把已压缩的录制好的音频/视频文件（如音乐、电影等）存储在服务器上。用户通过因特网下载这样的文件。请注意，用户并不是把文件全部下载完毕后再播放，因为这往往需要很长时间，而用户一般也不大愿意等待太长的时间。流式存储音频/视频文件的特点是能够边下载边播放，即在文件下载后不久（例如，几秒钟到几十秒钟后）就开始连续播放。
2. 流式实况: 流式实况音频/视频是一对多（而不是一对一）的通信。它的特点是：音频/视频节目不是事先录制好和存储在服务器中，而是在发送方边录制边发送（不是录制完毕后再发送）​。在接收时也是要求能够连续播放。接收方收到节目的时间和节目中的事件的发生时间可以认为是同时的（相差仅仅是电磁波的传播时间和很短的信号处理时间）​。流式实况音频/视频按理说应当采用多播技术才能提高网络资源的利用率，但目前实际上还是使用多个独立的单播。
3. 交互式音频/视频

## 8.2 流式存储音频/视频

使用传统的浏览器怎样从服务器下载音频/视频文件

1. 用户从客户机的浏览器上用HTTP协议向服务器请求下载某个音频/视频文件，GET请求下载HTTP报文
2. 服务器发送给RESPONSE
3. 当浏览器完全收下这个文件后，就可以传送给自己机器上的媒体播放器进行解压缩，然后播放

传统下载方法最大的缺点就是历时太长（几十分钟到几十小时）​，必须把所下载的音频/视频文件全部下载完毕后才能开始播放（差几个字节都不行）​。为此，已经找出了几种改进的措施。

### 8.2.1 具有元文件的万维网服务器

第一种改进的措施就是在万维网服务器中，除了真正的音频/视频文件外，还增加了一个元文件(metafile)。所谓元文件（请注意，不是源文件）就是一种非常小的文件，它描述或指明其他文件的一些重要信息。

使用元文件的万维网服务器

1. 浏览器用户点击所要看的音频/视频文件的超链，使用HTTP的GET报文接入到万维网服务器。实际上，这个超链并没有直接指向所请求的音频/视频文件，而是指向一个元文件。这个元文件有实际的音频/视频文件的统一资源定位符URL。
2. 万维网服务器把该元文件装入HTTP响应报文的主体，发回给浏览器。在响应报文中还有指明该音频/视频文件类型的首部。
3. 客户机浏览器收到万维网服务器的响应，分析其内容类型首部行，调用相关的媒体播放器（客户机中可能装有多个媒体播放器）​，把提取出的元文件传送给媒体播放器。
4. 媒体播放器使用元文件中的URL直接和万维网服务器建立TCP连接，并向万维网服务器发送HTTP请求报文，要求下载浏览器想要的音频/视频文件。
5. 万维网服务器发送HTTP响应报文，把该音频/视频文件发送给媒体播放器。媒体播放器在存储了若干秒的音频/视频文件后（这是为了消除抖动）​，就以音频/视频流的形式边下载、边解压缩、边播放。

### 8.2.2 媒体服务器

就是媒体播放器使用的是HTTP的服务。但HTTP是在TCP连接上运行的。TCP要重传出错的或丢失的报文段，因而不适合于流式音频/视频文件的传送。当网络出现拥塞时，流式音频/视频文件的播放就会暂停

可见，我们应当不使用TCP而使用UDP。由于万维网服务器都是使用HTTP协议，因此我们需要另外的一种服务器，即媒体服务器(media server)。

媒体服务器也称为流式服务器(streaming server)。媒体服务器和万维网服务器可以运行在一个端系统内，也可以运行在两个不同的端系统中。媒体服务器与普通的万维网服务器的最大区别就是，媒体服务器支持流式音频和视频的传送。媒体播放器与媒体服务器的关系是客户与服务器的关系。现在媒体播放器不是向万维网服务器而是向媒体服务器请求音频/视频文件。媒体服务器和媒体播放器之间采用另外的协议进行交互。

### 8.2.3 实时流式协议RTSP

实时流式协议 RTSP (Real-Time Streaming Protocol)是IETF的MMUSIC工作组(Multiparty MUltimedia SessIon Control WG，多方多媒体会话控制工作组)开发的协议[W-MMUSIC]​，现已成为因特网建议标准[RFC 2326]​。RTSP是为了给流式过程增加更多的功能而设计的协议。RTSP本身并不传送数据，而仅仅是使媒体播放器能够控制多媒体流的传送（有点像文件传送协议FTP有一个控制信道）​，因此RTSP又称为带外协议(out-of-band protocol)。

使用RTSP的媒体服务器的工作过程

1. 浏览器使用HTTP的GET报文向万维网服务器请求音频/视频文件。
2. 万维网服务器从浏览器发送携带有元文件的响应
3. 浏览器把收到的元文件传送给媒体播放器。
4. 媒体播放器的RTSP客户发送SETUP报文与媒体服务器的RTSP服务器建立连接。
5. 媒体服务器的RTSP服务器发送响应RESPONSE报文。
6. 媒体播放器的RTSP客户发送PLAY报文开始下载音频/视频文件（即开始播放）​。
7. 媒体服务器的RTSP服务器发送响应RESPONSE报文。此后，音频/视频文件被下载，所用的协议是运行在UDP上的。可以是后面要介绍的RTP，也可以是其他专用的协议。在音频/视频流播放的过程中，媒体播放器可以随时暂停（利用PAUSE报文）和继续播放（利用PLAY报文）​，也可以快进或快退。
8. 用户在不想继续观看时，可以由RTSP客户发送TEARDOWN报文断开连接。
9. 媒体服务器的RTSP服务器发送响应RESPONSE报文。

## 8.3 交互式音频/视频

IP电话

### 8.3.1 IP电话概述

狭义的IP电话就是指在IP网络上打电话。所谓“IP网络”就是“使用IP协议的分组交换网”的简称。这里的网络可以是因特网，也可以是包含有传统的电路交换网的互联网，不过在互联网中至少要有一个IP网络。

广义的IP电话则不仅仅是电话通信，而且还可以是在IP网络上进行交互式多媒体实时通信（包括话音、视像等）​，甚至还包括即时传信 IM (Instant Messaging)。即时传信是在上网时就能从屏幕上得知有哪些朋友也正在上网。若有，则彼此可在网上即时交换信息（文字的或声音的）​，也包括使用一点对多点的多播技术。

#### IP电话网关

IP电话网关（IP Telephony Gateway）​，它是公用电话网[插图]与IP网络的接口设备。IP电话网关的作用就是：

1. 在电话呼叫阶段和呼叫释放阶段进行电话信令的转换。
2. 在通话期间进行话音编码的转换。

#### IP电话的通话质量

IP电话的通话质量主要由两个因素决定，一个是通话双方端到端的时延和时延抖动，另一个是话音分组的丢失率。但这两个因素都是不确定的，而是取决于当时网络上的通信量。若网络上的通信量非常大以致发生了网络拥塞，那么端到端时延和时延抖动以及分组丢失率都会很高，这就导致IP电话的通话质量下降。因此，一个用户使用IP电话的通话质量取决于当时其他的许多用户的行为

### 8.3.2 IP电话所需要的几种应用协议

在IP电话的通信中，我们至少需要两种应用协议。一种是信令协议，它使我们能够在因特网上找到被叫用户[插图]。另一种是话音分组的传送协议，它使我们用来进行电话通信的话音数据能够以时延敏感属性在因特网中传送。

### 8.3.3 实时运输协议RTP

实时运输协议 RTP (Real-time Transport Protocol)

RTP [RFC 3550, 3551]为实时应用提供端到端的运输，但不提供任何服务质量的保证。需要发送的多媒体数据块（音频/视频）经过压缩编码处理后，先送给RTP封装成为RTP分组（也可称为RTP报文[插图]）​，RTP分组再装入运输层的UDP用户数据报，然后再向下递交给IP层。

RTP应当是应用层的一部分。在应用程序的发送端，开发者必须编写用RTP封装分组的程序代码，然后把RTP分组交给UDP套接字接口。在接收端，RTP分组通过UDP套接字接口进入应用层后，还要利用开发者编写的程序代码从RTP分组中把应用数据块提取出来

然而RTP的名称又隐含地表示它是一个运输层协议。这样划分也是可以的，因为RTP封装了多媒体应用的数据块，并且由于RTP向多媒体应用程序提供了服务（如时间戳和序号）​，因此也可以把RTP看成是在UDP之上的一个运输层子层的协议。

### 8.3.4 实时运输控制协议 RTCP

实时运输控制协议 RTCP (RTP Control Protocol)是与RTP配合使用的协议[RFC 3550, RFC 3551]​，实际上，RTCP协议也是RTP协议不可分割的部分。

RTCP协议的主要功能是：服务质量的监视与反馈、媒体间的同步（如某一个RTP发送的声音和图像的配合）​，以及多播组中成员的标志。RTCP分组（也可称为RTCP报文）也使用UDP来传送，但RTCP并不对音频/视频分组进行封装。由于RTCP分组很短，因此可把多个RTCP分组封装在一个UDP用户数据报中。RTCP分组周期性地在网上传送，它带有发送端和接收端对服务质量的统计信息报告

## 8.4 改进"尽最大努力交付"的服务

使因特网更好地传送多媒体信息的另一种方法，是改变因特网平等对待所有分组的思想，使得对时延有较严格要求的实时音频/视频分组，能够从网络得到更好的服务质量QoS。

