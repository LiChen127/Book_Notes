# 第二章HTML

## 2.3 WebKit的网页渲染过程

### 2.3.1 加载和渲染

浏览器的主要作用是将用户输入的"URL"转变为可视化的图像。

包含两个过程

1. 网页加载过程, 从URL到构建DOM树
2. 网页渲染过程, 从DOM树到生成可视化图像

有交叉，很难明确区分

网页渲染还有一个特性，那就是网页通常比我们的屏幕可视面积要大（在移动设备上尤其明显）​，而当前可见的区域，我们称为视图(viewport)

### 2.3.2 WebKit的渲染过程

1. 从URL -> build DOM Tree
    1. 用户输入URL，WebKit调用资源加载器加载该URL对应的网页
    2. 加载器依赖网络模块建立连接，发送请求并接收答复
    3. WebKit接受到各种网页/资源的数据，同步/异步
    4. 网页被交给HTML转变为一系列Token
    5. 解释器根据词语构建节点(Node), 形成DOM树
    6. 如果Node是JS代码，调用JS引擎解释并执行
    7. js可能修改DOM结构
    8. 如果节点需要依赖其他资源，例如图片、CSS、视频等，调用资源加载器来加载它们，但是它们是异步的，不会阻碍当前DOM树的继续创建; 如果是JavaScript资源URL(没有标记异步方式)，需要停止当前DOM树的创建，知道js资源加载完并被js引擎执行后才继续DOM树的创建
    上述过程中，网页在加载和渲染过程中会发出"DOMContent"事件和DOM的"onload"事件，分别在DOM树构建完之后，以及DOM树构建万，且网页所依赖的资源都加载完成之后才发生，因为某些资源的加载并不会阻碍DOM树的加载.
2. 从DOM树到构建完WebKit的绘图上下文(WebKit利用CSS和DOM树构建RenderObject树)知道绘图上下文:
    1. CSS文件被CSS解释器解释成内部表示结构
    2. CSS解释器工作完成之后，在DOM树上附加解释后的样式信息，这就是RenderObject树。
    3. RenderObject节点在创建的同时，WebKit会根据网页的层次结构创建RenderLayer树，同时构建虚拟的绘图上下文
3. 从绘图上下文到生成最终的图像
    1. 绘图上下文是一个与平台无关的抽象类，它将每个绘图操作桥接到不同的具体实现类
    2. 绘图实现类很复杂，需要借助Chromium的合成器来完成复杂的多进程和GPU加速机制
    3. 绘图实现类将2D/3D图形库绘制的结果保存，交给浏览器同浏览器界面一起展示。

